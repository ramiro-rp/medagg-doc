# ADR-0003 – Схема базы данных и основные связи (MVP)

- Статус: принято
- Дата: 2025-11-17
- Владельцы: DBA, backend‑разработчик
- Связанные документы:
  - `docs/db-schema.md`
  - `docs/db-schema.ru.md`
  - `docs/diagrams/er-medagg-core.png`
  - SQL‑скрипт DBA: `БД.sql`

## Контекст

Система должна описывать:

- **исходные наборы данных** (внешние коллекции изображений);
- **справочники**, описывающие эти наборы
  (анатомические области, модальности, типы ML‑задач, теги);
- **активность пользователей**, связанную с поиском и скачиванием коллекций.

Для MVP команда решила **не моделировать отдельные изображения** строками
в БД. Вместо этого БД отслеживает только датасеты и сформированные из них
коллекции, а детали на уровне файлов остаются в исходных ресурсах или
в структуре файлового хранилища.

Схема должна:

- быть достаточно простой для MVP и демонстрации;
- поддерживать эффективный поиск и фильтрацию по каталогу;
- позволять создавать и «протухать» пользовательские коллекции.

## Решение

Мы выбрали **реляционную схему в PostgreSQL** со следующими ключевыми сущностями:

- `roles`, `users` – учётные записи пользователей и их роли;
- `anatomical_areas`, `modalities`, `ml_tasks`, `tags` – справочники;
- `datasets` – исходные датасеты с основной метаинформацией и ссылками на хранилище;
- `dataset_modalities`, `dataset_ml_tasks`, `dataset_tags` – связи многие‑ко‑многим;
- `user_search_queries` – история поисковых запросов и фильтров;
- `user_dataset_collections` – коллекции датасетов, сформированные пользователем
  (с путём к архиву и сроком жизни);
- `collection_datasets` – связь между коллекциями и датасетами с опциональной
  оценкой релевантности.

Эта модель детально описана в **`docs/db-schema.md`** (и `docs/db-schema.ru.md`)
и визуализирована на диаграмме `docs/diagrams/er-medagg-core.png`.

## Рассмотренные альтернативы

### A. Моделировать каждое изображение в БД

Добавить таблицы вида `images` и `image_labels` с одной строкой на изображение.

- Плюсы:
  - точное отслеживание каждого изображения, попавшего в коллекцию;
  - гибкая аналитика по меткам и использованию изображений.
- Минусы:
  - более сложная схема и миграции;
  - значительно больший объём таблиц;
  - для текущих целей MVP это избыточно.

### B. Хранить всё в JSON‑полях

Держать основную метаинформацию о датасетах в JSON, а не в нормализованных таблицах.

- Плюсы:
  - гибкая структура, проще эволюционировать;
- Минусы:
  - сложнее выполнять эффективные запросы;
  - менее прозрачно для DBA и аналитических задач;
  - всё равно нужны структурированные таблицы для справочников и связей.

## Последствия

Положительные:

- понятная и явная модель данных для датасетов и коллекций;
- DBA могут проектировать индексы, ограничения и оценивать производительность;
- пользовательские коллекции воспроизводимы через таблицы
  `user_dataset_collections` и `collection_datasets`;
- схема совпадает с SQL‑скриптом, поддерживаемым DBA.

Отрицательные / риски:

- аналитика на уровне отдельных изображений требует обращения к исходным
  ресурсам или метаданным файловой системы, а не к реляционной схеме;
- если в будущих версиях понадобится строгое отслеживание изображений,
  схему придётся расширять (например, добавлять `images` / `image_labels`).

## Замечания

- Поле `storage_path_hdfs` в таблице `user_dataset_collections` по смыслу
  универсально: оно может указывать на локальный диск, примонтированный том,
  HDFS, объектное хранилище и т.п. Конкретную инфраструктуру определяют
  DevOps и решения по развёртыванию.
- Триггер устанавливает `expires_at = created_at + 1 day` для пользовательских
  коллекций; фоновые задания или cron‑скрипты должны периодически удалять
  протухшие архивы из хранилища.

## Ссылки

- `docs/db-schema.md`
- `docs/db-schema.ru.md`
- Диаграмма ER: `docs/diagrams/er-medagg-core.png`
- SQL‑скрипт: `БД.sql`
